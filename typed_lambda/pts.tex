\section{Pure Type Systems}

\subsection{Terms}

Convention: We use $s,s_1,s_2,\ldots$ to range over sorts,
$x,y,z,\ldots,x_1,x_2,\ldots$ to range over variables, $\alpha,\beta,\ldots$
to range over type variables and arbitrary letters $a,b,c,t,u,v,A,B,C,\ldots$
to range over arbitrary terms. Capital letters are used preferably to range
over terms which are meant to represent types.

\begin{definition}
  Typed lambda terms are defined by the grammar
  $$
  \begin{array}{llll}
    t &::=& s                 &\text{sort}
    \\
      &\mid& x                &\text{variable}
    \\
      &\mid& t t              &\text{application}
    \\
      &\mid& \lambda x^t.t    &\text{abstraction}
    \\
      &\mid& \Pi x^t.t        &\text{product}
  \end{array}
  $$
  where $s$ ranges over sorts, $x$ ranges over variables and $t$ ranges over
  terms.
\end{definition}


\subsection{Substitution}

\begin{definition}
  The expression $t[x:=a]$ substitutes in the term $t$ all free occurrences of
  the variable $x$ by the term $a$. It is defined by
  $$
  t[x:=a] :=
  \begin{cases}
    s[x:=a] &:= s
    \\
    x[x:=a] &:= a
    \\
    y[x:=a] &:= y \quad\text{for } x \ne y
    \\
    (f \, t)[x:=a] &:= f[x:=a] \, t[x:=a]
    \\
    (\lambda y^B.e)[x:=a] &:= \lambda y^{B[x:=a]}. e[x:=a]
    \quad y \text{ is fresh}
    \\
    (\Pi y^B.C)[x:=a] &:= \Pi y^{B[x:=a]}. C[x:=a]
    \quad y \text{ is fresh}
  \end{cases}
  $$.

  Note that bound variables in lambda abstractions and products must be chosen
  to be fresh i.e. not to occuer outside the binder. If the bound variables
  occur outside the binder, they have to be renamed into fresh variables
  before doing the substitution.
\end{definition}

For every lambda term with subterms, substitution is done on all substerms
separately. Care has to be taken when entering binders in abstractions and
products. Before entering the binder it has to be made sure that the bound
variable is renamed so that it does not occur outside the binder.


\begin{lemma}
  \label{doublesubstitution}
  \emph{Double Substitution}:
  $$
  \ruleh
  {x \neq y
    \\
    x \notin FV(b)
  }
  {t[x:=a][y:=b]\, = \, t[y:=b]\big[x:=a[y:=b]\big]}
  $$
  \begin{proof}
    By induction on the structure of $t$.

    The only interesting case is if $t$ is a variable e.g. $z$. The we have to
    prove
    $$ z[x:=a][y:=b]\, = \, z[y:=b]\big[x:=a[y:=b]\big].$$

    Three cases are possible:
    \begin{enumerate}
    \item
      $z \ne x \land z \ne y$: In this case no substitution takes place and we
      have the trivial equality $z = z$.

    \item $z = x$: Since $x \ne y$ we get $a = a$.

    \item $z = y$: In that case we get $b = b$.
    \end{enumerate}

    If $t$ is an application, an abstraction or a product, the induction
    hypothesis and the definition of substitution are sufficient to prove the
    corresponding goal.
  \end{proof}
\end{lemma}





\subsection{Reduction}

\begin{definition}
  The reduction relation $\reduce$ is defined as the compatible closure
  of
  $$
  (\lambda x^A. e) a \reduce e[x:=a]
  $$
\end{definition}

Compatible closure means that we can reduce a term by reducing one of its
subterms. I.e. we have the following additional rules to define the reduction
relation completely: $\ruleh {a \reduce b}{ac \reduce bc}$,
$\ruleh {b \reduce c}{ab \reduce ac}$,
$\ruleh {A \reduce B} {\lambda x^A.e \reduce \lambda x^B. e}$,
$\ruleh {e \reduce f} {\lambda x^A.e \reduce \lambda x^A. f}$,
$\ruleh {A \reduce B} {\Pi x^A.C \reduce \Pi x^B. C}$,
$\ruleh {B \reduce C} {\Pi x^A.B \reduce \Pi x^A. C}$.



\begin{lemma}
  \label{reductionsubstitution}
  \emph{Reduction Substitution}:
  $$
  \ruleh
  {t \reduce u
  }
  {t[x:=a] \reduce u[x:=a]}
  $$
  \begin{proof} By induction on $t \reduce u$ where we use the abbreviation
    $w' := w[x:=a]$ for any term $w$.

    Let's first analyze the case that $t \reduce u$ is valid because of the
    rule $(\lambda y^B.e) b \reduce e[y:=b]$.
    $$
    \begin{array}{llll}
      ((\lambda y^B.e) b)'
      &=& (\lambda y^{B'}. e') b'
      &\text{definition of substitution}
      \\
      &\reduce & e'[y:=b'] &\text{reduction rule}
      \\
      &=& e[x:=a]\big[[y:=b[x:=a]\big]   &\text{abbreviation}
      \\
      &=& e[y:=b][x:=a]
      &\text{double substitution~\ref{doublesubstitution}}
      \\
      &=& e[y:=b]'  &\text{abbreviation}
    \end{array}
    $$

    Next we analyze the case $\ruleh{b \reduce c}{bd \reduce cd}$.

    $$
    \begin{array}{l|ll}
      b \reduce c    & b' \reduce c' & \text{induction hypo}
      \\ \hline
      bd \reduce cd  & (bd)' \reduce (cd)' & \text{goal}
    \end{array}
    $$
    The goal $(bd)' \reduce (cd)'$ is proved by the derivation
    $$
    \begin{array}{llll}
      (bd)'
      &=& b' d'        &\text{definition of substitution}
      \\
      &\reduce& c' d'  &\text{induction hypo}
      \\
      &=& (cd)'        &\text{definition of substitution}
    \end{array}
    $$

    For the remaining rules where just subterms are substituted the proofs are
    similar. The corresponding induction hypothesis with the definition of
    substitution is sufficient to proof the goal.
  \end{proof}
\end{lemma}


\subsection{Kinds and Types}

\begin{definition}
  The set of products is defined inductively by the rules
  \begin{enumerate}

  \item $s \in \Products$

  \item $x \abold \in \Products$

  \item
    $\ruleh{A \in \Products \quad B \in \Products}{\Pi x^A.B \in \Products}$
  \end{enumerate}
\end{definition}

Sorts and variables are empty or degenerate products. Terms of the form
$\Pi x^A.B$ are proper products.

\begin{definition}
  The set of kinds is defined inductively by the rules
  \begin{enumerate}

  \item $s \in \Kinds$

  \item $\ruleh{ A \in \Products \quad k \in \Kinds}{\Pi x^A.k \in \Kinds}$

  \item $\ruleh
    {k \in \Kinds \quad l \reduce k}
    {l \in \Kinds}$
  \end{enumerate}

\end{definition}



\begin{definition}
  The set of Types is defined inductively by the rules
  \begin{enumerate}

  \item $x \in \Types$

  \item $\ruleh{A \in \Products \quad B \in \Types}{\Pi x^A.B \in \Types}$

  \item $\ruleh
    {U \in \Types \quad T \reduce U}
    {T \in \Types}$
  \end{enumerate}

\end{definition}

Note that the set $\Kinds$ and the set $\Types$ are just syntactical
categories. There is no guarantee that the terms in these sets are wellformed
according to any typing relation. The terms just satisfy some syntax rules.


\subsection{Contexts}

\begin{definition}
  A context $\Gamma = [x_1:T_1, \ldots, x_n:T_n]$ is a list of variables
  together with their types. The types $T_i$ are lambda terms. No duplicate
  variables are allowed. We use the notation
  $\Gamma,x:T = [x_1:T_1, \ldots, x_n:T_n, x:T]$ to introduce the new fresh
  variable $x$ with its type $T$ into the context $\Gamma$.
\end{definition}

The substitution function can be extended to contexts $\Gamma[x:=a]$ by
applying the substitution to each type in the context or formally
$$
\Gamma[x:=a] :=
\begin{cases}
  [][x:=a] &:= []
  \\
  (\Gamma,y:T)[x:=a] &:= \Gamma[x:=a],y:T[x:=a]
\end{cases}
$$



\subsection{The Typing Relation}

\begin{definition}
  A pure type system has a set of sorts $S$, a set of axioms
  $\{(s_1,s_2), \ldots\}$ and a set of rules $\{(s_1,s_2,s_3), \ldots \}$ and
  the inductively defined typing relation $\Gamma \vdash t: T$ where $\Gamma$
  is a context and $t$ and $T$ are terms.
  \begin{description}

  \item[Axiom] $$\ruleh{ \text{axiom}(s_1,s_2)}{[] \vdash s_1:s_2}$$

  \item[Variable]
    $$\ruleh{\Gamma \vdash A:s\quad x \notin \Gamma}{\Gamma,x:A \vdash x:A}$$


  \item[Weaken]
    $$\ruleh
    {\Gamma \vdash A:s \quad  \Gamma \vdash t:T   \quad x \notin \Gamma}
    {\Gamma,x:A \vdash t:T}$$


  \item[Product]
    $$\ruleh
    {\Gamma \vdash A:s_1 \quad
      \Gamma,x:A \vdash B:s_2 \quad
      \text{rule}(s_1,s_2,s_3)}
    {\Gamma \vdash \Pi x^A . B : s_3}
    $$

  \item[Abstraction]
    $$\ruleh
    {\Gamma \vdash \Pi x^A.B: s \quad
      \Gamma,x:A \vdash e:B
    }
    {\Gamma \vdash \lambda x^A.e : \Pi x^A . B}
    $$

  \item[Application]
    $$\ruleh
    {\Gamma \vdash f: \Pi x^A.B \quad
      \Gamma \vdash a:A
    }
    {\Gamma \vdash f a : B[x:=a]}
    $$

  \item[Type Reduction]
    $$\ruleh
    {\Gamma \vdash t: T \quad
      \Gamma\vdash U: s \quad
      (T \reduce U) \lor (U \reduce T)
    }
    {\Gamma \vdash t: U}
    $$
  \end{description}
\end{definition}

We use the following definitions:
\begin{enumerate}

\item A context $\Gamma$ is legal if $\Gamma \vdash t:T$ is valid for some $t$
  and $T$.


\item A term $A$ is legal if $\Gamma \vdash a:A$ is valid for some $\Gamma$
  and $a$ or if $\Gamma\vdash A:T$ is valid for some $\Gamma$ and $T$.
\end{enumerate}




\begin{theorem} Substitution Lemma
  \label{substitutionlemma}
  $$
  \rulev
  { \Gamma \vdash a:A
    \\
    \Gamma,x:A,\Delta \vdash t:T
  }
  % --------------------------------------------
  {\Gamma,\Delta[x:=a] \vdash t[x:=a] : T[x:=a]}
  $$
  \begin{proof}
    We abbreviate $V[x:=a]$ by $V'$ where $V$ can be a term or a context.

    The assertion $\Gamma,x:A,\Delta \vdash t:T$ is not very suited for doing
    induction on. Therefore we reformulate the goal to
    $$
    \rulev{
      \Gamma_0\vdash a:A
      \\
      \Gamma \vdash t : T
    }
    {\forall \Delta .
      \rulev{\Gamma = \Gamma_0,x:A,\Delta}
      {\Gamma_0,\Delta' \vdash t' : T'}
    }
    $$
    which is equivalent to the original goal. Now we assume
    $\Gamma_0\vdash a:A$ and do induction on $\Gamma \vdash t : T$.

    \begin{description}

    \item[Axiom] The goal is vacuously satisfied because there is no $\Delta$
      to satisfy $[] = \Gamma_0,x:A,\Delta$.

    \item[Variable]
      $$
      \begin{array}{l|l}
        \Gamma \vdash B:s
        & \forall \Delta .
          \rulev
          {\Gamma = \Gamma_0,x:A,\Delta}
          {\Gamma_0,\Delta' \vdash B' : s'} \quad(h_1)
        \\
        y \notin \Gamma
        \\
        \hline
        \Gamma,y:B \vdash y:B
        & \goalbg{
          \forall \Delta .
          \rulev
          {\Gamma,y:B = \Gamma_0,x:A,\Delta}
          {\Gamma_0,\Delta' \vdash y': B'}
          }
      \end{array}
      $$

      Now we assume $\Gamma,y:B = \Gamma_0,x:A,\Delta$ and do a case split on
      the structure of $\Delta$.
      \begin{enumerate}

      \item Case $\Delta = []$. This is possible only for $\Gamma = \Gamma_0$,
        $x=y$ and $A = B$. Since $x \notin \Gamma_0$ and by assumption
        $\Gamma_0 \vdash a:A$ we can conclude that $x \notin \freevars(A)$ and
        therefore $A = A'$ so that the goal $\Gamma_0 \vdash x': A'$ is
        satisfied.

      \item Case $\Delta = \Delta_0,y:B$. This implies
        $\Gamma = \Gamma_0,x:A,\Delta_0$. If we feed $\Delta_0$ into the
        induction hypothesis $(h_1)$ we get
        $ \Gamma_0,\Delta_0' \vdash B': s'$. Since $y$ is fresh we have
        $y' = y$. By using the \emph{variable} rule we get the final goal
        $\Gamma_0,\Delta_0',y:B' \vdash y:B'$ i.e.
        $\Gamma_0,\Delta' \vdash y:B'$ because $\Delta' = \Delta_0',y:B'$ by
        definition.

      \end{enumerate}


    \item[Weaken]
      $$
      \begin{array}{l|l}
        \Gamma \vdash B:s
        & \forall \Delta .
          \rulev
          {\Gamma = \Gamma_0,x:A,\Delta}
          {\Gamma_0,\Delta' \vdash B' : s'} \quad(h_1)
        \\
        y \notin \Gamma
        \\
        \Gamma \vdash t:T
        & \forall \Delta .
          \rulev
          {\Gamma = \Gamma_0,x:A,\Delta}
          {\Gamma_0,\Delta' \vdash t': T'} \quad (h_2)
        \\
        \hline % -------------------------------------
        \Gamma,y:B \vdash y:B
        & \goalbg{
          \forall \Delta .
          \rulev
          {\Gamma,y:B = \Gamma_0,x:A,\Delta}
          {\Gamma_0,\Delta' \vdash t': T'}
          }
      \end{array}
      $$

      Now we have to do the same case split on the structure of $\Delta$ as in
      the \emph{variable} rule, this time however using the induction
      hypothesis $(h_2)$ and the \emph{weakening} rule to prove the final
      goal.

    \item[Product]
      $$
      \begin{array}{l|l}
        \text{rule}(s_1,s_2,s_3)
        \\
        \Gamma \vdash B:s_1
        % hypo 1
        & \forall \Delta .
          \rulev
          {\Gamma = \Gamma_0,x:A,\Delta}
          {\Gamma_0,\Delta' \vdash B': s_1'} \quad (h_1)
        \\
        \Gamma,y:B \vdash C:s_2
        % hypo 2
        &  \forall \Delta .
          \rulev
          {\Gamma,y:B = \Gamma_0,x:A,\Delta}
          {\Gamma_0,\Delta' \vdash C': s_2'} \quad (h_2)
        \\
        \hline
        \Gamma \vdash \Pi y^B . C: s_3
        & \goalbg{
          \forall \Delta .
          \rulev
          {\Gamma = \Gamma_0,x:A,\Delta}
          {\Gamma_0,\Delta' \vdash (\Pi y^B. C)' : s_3'}
          }
      \end{array}
      $$

      We assume $\Gamma = \Gamma_0,x:A,\Delta$ and want to derive the goal
      $\Gamma_0,\Delta' \vdash \Pi y^{B'}. C' : s_3$.

      In order to derive the goal by the \emph{product} rule we need the
      premises $\Gamma_0,\Delta' \vdash B': s_1$ and
      $\Gamma_0,\Delta',y:B' \vdash C': s_2$.

      The first one can be derived directly from $(h_1)$. The second one can
      be obtained for $(h_2)$ by using $\Delta,y:B'$ for $\Delta$. The premise
      $\Gamma,y:B = \Gamma_0,x:A,\Delta,y:B$ of $(h_2)$ is then a direct
      consequence of the assumption.

    \item[Abstraction] Like the \emph{product} rule.

    \item[Application]
      $$
      \begin{array}{l|ll}
        \Gamma\vdash f: \Pi y^B.C
        &\forall \Delta .
          \rulev
          {\Gamma = \Gamma_0,x:A,\Delta}
          {\Gamma_0,\Delta' \vdash f': (\Pi y^B.C)'} & (h_1)
        \\
        \Gamma \vdash b: B
        &\forall \Delta .
          \rulev
          {\Gamma = \Gamma_0,x:A,\Delta}
          {\Gamma_0,\Delta' \vdash b': B'} & (h_2)
        \\
        \hline %-------------------------------------------
        \Gamma \vdash f\, b : C[y:=b]
        & \goalbg{
          \forall \Delta .
          \rulev
          {\Gamma = \Gamma_0,x:A,\Delta}
          {\Gamma_0,\Delta' \vdash (f b)': C[y:=b]'}
          }
      \end{array}
      $$
      Let's assume $\Gamma = \Gamma_0,x:A,\Delta$.

      The hypotheses $(h_1)$ and $(h_2)$ let us derive
      $\Gamma_0,\Delta' \vdash f': \Pi y^{B'}.C'$ and
      $\Gamma_0,\Delta' \vdash b': B'$
      which by the \emph{application} rule lead to
      $\Gamma_0,\Delta' \vdash (f b)' : C'[y:=b']$.

      The double substitution law~\ref{doublesubstitution}
      $$
      \begin{array}{llll}
        C[y:=b]'
        & = & C[y:=b][x:=a]       & \text{definition } V'\\
        & = & C[x:=a]\big[y:=b[x:=a]\big] & \text{double substitution} \\
        & = & C'[y:=b']           & \text{definition } V'
      \end{array}
      $$
      derives the equality $C'[y:=b'] = C[y:=b]'$ which immediately proves the
      goal.

    \item[Reduction]
      $$
      \begin{array}{l|ll}
        \Gamma \vdash t:T
        & \forall \Delta .
          \rulev
          {\Gamma = \Gamma_0,x:A,\Delta}
          {\Gamma_0,\Delta' \vdash t': T'} & (h_1)
        \\
        \Gamma \vdash U: s
        & \forall \Delta .
          \rulev
          {\Gamma = \Gamma_0,x:A,\Delta}
          {\Gamma_0,\Delta' \vdash U': s'} & (h_2)
        \\
        (T \reduce U) \lor (U \reduce T)
        \\
        \hline %-------------------------------------------
        \Gamma \vdash t:U
        & \goalbg{
          \forall \Delta .
          \rulev
          {\Gamma = \Gamma_0,x:A,\Delta}
          {\Gamma_0,\Delta' \vdash t': U'}
          }
      \end{array}
      $$
      From the substitution rule for reduction~\ref{reductionsubstitution} and
      the premise $(T \reduce U) \lor (U \reduce T)$ we get
      $(T' \reduce U') \lor (U' \reduce T')$.

      Together with the two induction hypotheses $(h_1)$ and $(h_2)$ and
      applying the \emph{reduction} rule we can immediately prove the goal.
    \end{description}
  \end{proof}
\end{theorem}










\begin{theorem} The type $T$ of a term $t$ is either a sort or its type is a
  sort
  $$
  \ruleh
  {\Gamma \vdash t:T}
  {\exists s. T = s \lor \Gamma\vdash T:s}.
  $$

  \begin{proof}
    By induction on $\Gamma\vdash t:T$.
    \begin{description}

    \item[Axiom] Trivial.


    \item[Variable]
      $\ruleh
      {\Gamma\vdash B:s}
      {\Gamma,x:B \vdash x:B}
      $. Trivial, witness $s$.

    \item[Weaken]
      $$
      \begin{array}{l|l}
        \Gamma \vdash A:s &
        \\
        \Gamma \vdash t:T & \exists s. T = s \lor \Gamma \vdash T:s
        \\
        \hline
        \Gamma,x:A \vdash t:T   & \exists s.
                                  T = s \lor \Gamma,x:A \vdash T:s
      \end{array}
      $$
      The goal is a consequence of the induction hypothesis and an
      application of the weakening rule in case $\Gamma\vdash T:s$.

    \item[Product] Trivial, because the type of a product is always a sort.

    \item[Abstraction] Trivial, because the type of an abstraction is a
      product whose type is always a sort.

    \item[Application]
      $$
      \begin{array}{l|l}
        \Gamma\vdash f:\Pi x^A.B & \exists s. \Pi x^A.B = s \lor
                                   \Gamma\vdash \Pi x^A.B: s
        \\
        \Gamma\vdash a:A
        \\
        \hline
        \Gamma\vdash f a:B[x:=a] & \exists s. B[x:=a] = s \lor
                                   \Gamma\vdash B[x:=s]: s
      \end{array}
      $$
      The type of a product is always a sort. Therefore
      $\Gamma\vdash \Pi x^A.B : s $ must be valid for some sort $s$. The
      product can only be formed if $\Gamma,x:A \vdash B:s$ is valid for some
      sort $s$. By the substition lemma~\ref{substitutionlemma} we get $\Gamma
      \vdash B[x:=a]: s$.

    \item[Reduction]
      $$
      \begin{array}{l|l}
        \Gamma\vdash t:T \\
        \Gamma\vdash U: s \\
        (T \reduce U) \lor (U \reduce T) \\
        \hline
        \Gamma\vdash t:U & \exists s. U = s \lor \Gamma\vdash U:s
      \end{array}
      $$
      Trivial by the second premise.
    \end{description}
  \end{proof}
\end{theorem}
